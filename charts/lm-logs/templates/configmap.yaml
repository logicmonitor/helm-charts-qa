{{- /* Accept any of: userDefinedSecret, bearerToken value, or id+key values */ -}}
  {{- if not (include "lm-logs.credsProvided" .) -}}
  {{- fail "Provide credentials via Secret (global.userDefinedSecret) or via global.* / lm_* values." -}}
  {{- end -}}
  {{- include "lm-logs.assertInputs" . -}}

  {{- /* Only create this ConfigMap if the user did NOT supply fluentd.existingConfigMap */ -}}
  {{- if not .Values.fluentd.existingConfigMap }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "fluentd.fullname" . }}
  labels:
    {{- include "fluentd.labels" . | nindent 4 }}
  annotations:
    {{- include "fluentd.annotations" . | nindent 4 }}
data:
  fluent.conf: |
    {{- if .Values.fluentd.enableTplRendering }}
    {{- tpl (.Values.fluentd.config | toString) . | nindent 4 }}
    {{- else }}
    {{- .Values.fluentd.config | nindent 4 }}
    {{- end }}

  {{- range $name, $content := .Values.fluentd.extraFiles }}
  {{ $name }}: |
    {{- if $.Values.fluentd.enableTplRendering }}
{{ tpl ($content | toString) $ | nindent 4 }}
    {{- else }}
{{ $content | nindent 4 }}
    {{- end }}
  {{- end }}
  {{- /* If systemd is enabled AND user didn't already define systemd.conf in extraFiles */ -}}
  {{- if and .Values.useSystemdConf (not (hasKey .Values.fluentd.extraFiles "systemd.conf")) }}
  systemd.conf: |
    {{- if .Values.systemd.conf }}
{{ .Values.systemd.conf | nindent 4 }}
    {{- else }}
{{ include "fluentd.systemdConfBlock" (dict "context" .) | nindent 4 }}
    {{- end }}
  {{- end }}
{{- end }}
